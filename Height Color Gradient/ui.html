<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #content {
      font-family: Inter, sans-serif;
      font-size: 12px;
      padding: 16px;
      background: #f5f5f5;
      color: #333;
    }

    h3 {
      margin-bottom: 8px;
      font-weight: 500;
    }

    .stop-row {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
      background-color: #eaeaea;
      border-radius: 4px;
      border: 1px solid #f5f5f5;
      padding: 4px 8px;
    }

    .stop-row:hover {
      border: 1px solid #ccc;
    }

    .drag-handle {
      display: flex;
      flex-wrap: wrap;
      width: 10px;
      height: 20px;
      gap: 2px;
      align-content: center;
      justify-content: center;
      cursor: grab;
      margin-right: 4px;
    }

    .drag-handle div {
      width: 3px;
      height: 3px;
      background: #888;
      border-radius: 50%;
    }

    .stop-row input[type="color"] {
      -webkit-appearance: none;
      border: none;
      width: 16px;
      height: 16px;
      border-radius: 4px;
      padding: 0;
      background: none;
      cursor: pointer;
    }

    .stop-row input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 0;
      border-radius: 4px;
    }

    .stop-row input[type="color"]::-webkit-color-swatch {
      border: none;
      border-radius: 4px;
    }

    .stop-row input[type="text"] {
      width: 72px;
      background: none;
      padding: 0 12px 0 0;
      border-width: 0 1px 0 0;
      border-color: #f5f5f5;
      color: #333;
    }

    .stop-row input[type="number"] {
      width: 32px;
      text-align: right;
      background: none;
      border: none;
      color: #333;
    }

    /* Chrome, Safari, Edge, Opera */
    .stop-row input[type="number"]::-webkit-outer-spin-button,
    .stop-row input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    /* Firefox */
    .stop-row input[type="number"] {
      -moz-appearance: textfield;
    }

    .stop-row button {
      background: none;
      border: none;
      color: #888;
      cursor: pointer;
      font-size: 14px;
    }

    .stop-row button:hover {
      color: #333;
    }

    #preview {
      height: 24px;
      border-radius: 4px;
      margin: 8px 0 16px 0;
    }

    .presets {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .preset {
      height: 24px;
      width: 48px;
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid #eaeaea;
    }

    .preset:hover {
      border: 1px solid #ccc;
    }

    button#addstop {
      border: 1px solid #eaeaea;
      border-radius: 4px;
      padding: 4px 8px;
      color: #333;
    }

    button#addstop:hover {
      border: 1px solid #ccc;
    }

  .checkbox-container {
    display: inline-flex;
    align-items: center;
    gap: 0.5em;
    cursor: pointer;
    user-select: none;
    margin-top: 12px;
  }

  .checkbox-container input[type="checkbox"] {
    display: none;
  }

  .custom-checkbox {
    width: 16px;
    height: 16px;
    border: 2px solid #ccc;
    border-radius: 4px;
    background-color: white;
    position: relative;
  }

  .checkbox-container input[type="checkbox"]:checked + .custom-checkbox {
    background-color: #18a0fb;
    border-color: #18a0fb;
  }

  .checkbox-container input[type="checkbox"]:checked + .custom-checkbox::after {
    content: "";
    position: absolute;
    left: 4px;
    top: 1px;
    width: 5px;
    height: 9px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }

    button.primary {
      width: 100%;
      background-color: #18a0fb;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 12px 16px;
      cursor: pointer;
      font-weight: 500;
      font-size: 1em;
    }
  </style>
</head>
<body>
  <div id="content">
    <h3>Preview Gradient</h3>
    <div id="preview"></div>
    <div id="stops"></div>
    <button id="addStop">+ Add Stop</button>
    <hr style="margin: 16px 0; border: none; border-top: 1px solid #ccc;" />
    <h3>Example Gradients</h3>
    <div class="presets" id="presets"></div>
    <hr style="margin: 16px 0; border: none; border-top: 1px solid #ccc;" />
    <button id="apply" class="primary">Apply Gradient</button>
    <div>
      <label class="checkbox-container">
        <input type="checkbox" id="useParentHeight" />
        <span class="custom-checkbox"></span>
        Use parent height
      </label>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
    const stopsContainer = document.getElementById("stops");
    const preview = document.getElementById("preview");
    const presetsContainer = document.getElementById("presets");

    const defaultPresets = [
      [
        { color: "#33ff66", position: 0 },
        { color: "#FFFF66", position: 50 },
        { color: "#FF4444", position: 100 }
      ],
      [
        { color: "#7866FF", position: 0 },
        { color: "#C266FF", position: 25 },
        { color: "#FF6666", position: 50 },
        { color: "#FFFF65", position: 75 },
        { color: "#66FF66", position: 100 }
      ],
      [
        { color: "#FFFFFF", position: 0 },
        { color: "#FFFF66", position: 15 },
        { color: "#FF8F1F", position: 30 },
        { color: "#9D00FF", position: 60 },
        { color: "#260052", position: 100 }
      ],
      [
        { color: "#ffffff", position: 0 },
        { color: "#000000", position: 100 }
      ]
    ];

    function hexToRgb(hex) {
      const bigint = parseInt(hex.slice(1), 16);
      return {
        r: ((bigint >> 16) & 255) / 255,
        g: ((bigint >> 8) & 255) / 255,
        b: (bigint & 255) / 255
      };
    }

    function createStop(hex = "#ff0000", position = 0) {
      const div = document.createElement("div");
      div.className = "stop-row";
      div.innerHTML = `
        <div class="drag-handle" title="Drag to reorder">
          <div></div><div></div>
          <div></div><div></div>
          <div></div><div></div>
        </div>
        <input type="color" value="${hex}">
        <input type="text" value="${hex}">
        <input type="number" min="0" max="100" value="${position}">%
        <button title="Remove">âœ•</button>
      `;

      const inputs = div.querySelectorAll("input");
      const colorInput = inputs[0];
      const hexInput = inputs[1];
      const percentInput = inputs[2];
      const removeBtn = div.querySelector("button");

      colorInput.addEventListener("input", () => {
        hexInput.value = colorInput.value;
        updatePreview();
      });

      hexInput.addEventListener("input", () => {
        colorInput.value = hexInput.value;
        updatePreview();
      });

      percentInput.addEventListener("input", updatePreview);
      removeBtn.addEventListener("click", () => {
        div.remove();
        updatePreview();
        resizeToContent();
        updateRemoveButtons();
      });

      stopsContainer.appendChild(div);
      resizeToContent();
    }

    function updatePreview() {
      const stops = getStops();
      const gradient = stops.map(s => `${s.color} ${s.position}%`).join(', ');
      preview.style.background = `linear-gradient(to right, ${gradient})`;
    }

    function getStops() {
      return Array.from(stopsContainer.children).map(child => {
        const inputs = child.querySelectorAll("input");
        return {
          color: inputs[0].value,
          position: parseFloat(inputs[2].value)
        };
      });
    }

    function handleSmartReorder(oldIndex, newIndex) {
      const stops = Array.from(stopsContainer.children);
      const moved = stops[newIndex];
      const movedInput = moved.querySelectorAll("input")[2];

      if (Math.abs(oldIndex - newIndex) === 1) {
        // Simple swap
        const swapped = stops[oldIndex];
        const swappedInput = swapped.querySelectorAll("input")[2];

        const tmp = movedInput.value;
        movedInput.value = swappedInput.value;
        swappedInput.value = tmp;
        return;
      }

      // Determine new value based on position
      if (newIndex === 0) {
        movedInput.value = 0;
        // bump old first (now at index 1) if needed
        const second = stops[1].querySelectorAll("input")[2];
        if (parseFloat(second.value) <= 0) second.value = 10;
      } else if (newIndex === stops.length - 1) {
        movedInput.value = 100;
        const secondLast = stops[stops.length - 2].querySelectorAll("input")[2];
        if (parseFloat(secondLast.value) >= 100) secondLast.value = 90;
      } else {
        const before = parseFloat(stops[newIndex - 1].querySelectorAll("input")[2].value);
        const after = parseFloat(stops[newIndex + 1].querySelectorAll("input")[2].value);
        movedInput.value = Math.round((before + after) / 2);
      }
    }

    function resizeToContent() {
      requestAnimationFrame(() => {
        const content = document.getElementById('content');
        const height = content.scrollHeight;
        parent.postMessage({ pluginMessage: { type: 'resize-ui', height } }, '*');
      });
    }

    function applyPreset(stops) {
      stopsContainer.innerHTML = '';
      stops.forEach(stop => createStop(stop.color, stop.position));
      updatePreview();
      resizeToContent();
      updateRemoveButtons();
    }

    document.getElementById("addStop").onclick = () => {
      createStop("#888888", 100);
      updatePreview();
      resizeToContent();
      updateRemoveButtons();
    };

    document.getElementById("apply").onclick = () => {
      const stops = getStops().map(s => ({
        color: hexToRgb(s.color),
        position: s.position
      }));
      const useParentHeight = document.getElementById('useParentHeight').checked;
      parent.postMessage({ pluginMessage: { type: "apply-gradient", stops, useParentHeight } }, "*");
    };

    defaultPresets.forEach(preset => {
      const div = document.createElement("div");
      div.className = "preset";
      div.style.background = `linear-gradient(to right, ${preset.map(s => `${s.color} ${s.position}%`).join(', ')})`;
      div.onclick = () => applyPreset(preset);
      presetsContainer.appendChild(div);
    });

    // Enable drag handle with position swap logic
    new Sortable(stopsContainer, {
      animation: 150,
      handle: ".drag-handle",
      onEnd: ({ oldIndex, newIndex }) => {
        handleSmartReorder(oldIndex, newIndex);
        updatePreview();
      }
    });

    function updateRemoveButtons() {
      const stops = stopsContainer.querySelectorAll(".stop-row");
      const showRemove = stops.length > 2;

      stops.forEach(stop => {
        const btn = stop.querySelector("button");
        btn.style.visibility = showRemove ? "visible" : "hidden";
      });
    }

    // Initial state
    applyPreset(defaultPresets[0]);
    resizeToContent();
  </script>
</body>
</html>